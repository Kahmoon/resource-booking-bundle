"use strict";class resourceBookingApp{constructor(e,o){new Vue({el:e,data:{options:{requestToken:"",moduleKey:"",audio:{notifyOnNewBookingsAudio:"bundles/markocupicresourcebooking/audio/bell.mp3"},enableAudio:!0,callbacks:{onBeforeBookingRequest:e=>!0,onAfterBookingRequest:()=>{}}},isReady:!1,mode:"main-window",lastResponseStatus:200,filterBoard:null,userIsLoggedIn:!1,loggedInUser:[],weekdays:[],timeSlots:[],rows:[],activeResourceTypeId:"undefined",activeResourceType:[],activeResourceId:"undefined",activeResource:[],activeWeekTstamp:0,activeWeek:[],bookingRepeatsSelection:[],bookingWindow:[],bookingFormValidation:[],intervals:[],messages:null,isIdle:!1,isBusy:!1},created:function(){let e=this;window.navigator.userAgent.indexOf("MSIE ")>0&&alert("This plugin is not compatible with your browser. Please use a current browser (like Opera, Firefox, Safari or Google Chrome), that is not out of date."),e.options={...e.options,...o},window.setTimeout(()=>{e.fetchDataRequest()},2e3),e.intervals.fetchDataRequest=window.setInterval(()=>{e.isIdle||e.isBusy||e.fetchDataRequest()},15e3);window.setTimeout(()=>{e.initializeIdleDetector(document,3e5)},1e4),document.addEventListener("keyup",o=>{27===o.keyCode&&"booking-window"===e.mode&&e.hideBookingWindow()})},watch:{isReady:function(e){},activeResourceTypeId:function(e,o){this.applyFilterRequest(e,this.activeResourceId,this.activeWeekTstamp)},activeResourceId:function(e,o){this.applyFilterRequest(this.activeResourceTypeId,e,this.activeWeekTstamp)},activeWeekTstamp:function(e,o){this.applyFilterRequest(this.activeResourceTypeId,this.activeResourceId,e)},rows:function(e,o){let t=this;if(0===e.length||0===o.length)return;let i=!1;Object.keys(e).forEach(t=>{Object.keys(e[t].cellData).forEach(n=>{!0===e[t].cellData[n].isBooked&&!1===o[t].cellData[n].isBooked&&e[t].cellData[n].mondayTimestampSelectedWeek===o[t].cellData[n].mondayTimestampSelectedWeek&&e[t].cellData[n].resourceId===o[t].cellData[n].resourceId&&(i=!0)})}),!0===i&&t.options.enableAudio&&t.playAudio(t.options.audio.notifyOnNewBookingsAudio)}},methods:{fetchDataRequest:function(){let e=this;e.isBusy=!0;let o=new FormData;o.append("REQUEST_TOKEN",e.options.requestToken),o.append("action","fetchDataRequest"),o.append("moduleKey",e.options.moduleKey),fetch(window.location.href,{method:"POST",body:o,headers:{"x-requested-with":"XMLHttpRequest"}}).then(o=>(e.checkResponse(o),o.json())).then(o=>{if("success"===o.status)for(let t in o.data)e[t]=o.data[t];return o}).then(o=>{e.isReady=!0,e.isBusy=!1}).catch(o=>{e.isReady=!1,e.isBusy=!1})},applyFilterRequest:function(e,o,t){let i=this;i.isBusy=!0,i.toggleBackdrop(!0);let n=new FormData;n.append("REQUEST_TOKEN",i.options.requestToken),n.append("action","applyFilterRequest"),n.append("resType",e),n.append("res",o),n.append("date",t),n.append("moduleKey",i.options.moduleKey),fetch(window.location.href,{method:"POST",body:n,headers:{"x-requested-with":"XMLHttpRequest"}}).then(e=>(i.checkResponse(e),e.json())).then(e=>("success"===e.status&&Object.keys(e.data).forEach(o=>{i[o]=e.data[o]}),e)).then(e=>{i.toggleBackdrop(!1),i.isBusy=!1}).catch(e=>{i.toggleBackdrop(!1),i.isBusy=!1})},bookingRequest:function(){let e=this,o=e.$el.querySelector(".booking-window form");o||console.error("Form not found");let t=new FormData(o);t.append("REQUEST_TOKEN",e.options.requestToken),t.append("action","bookingRequest"),t.append("resourceId",e.bookingWindow.activeTimeSlot.resourceId),t.append("description",e.$el.querySelectorAll('.booking-window [name="bookingDescription"]')[0].value),t.append("bookingRepeatStopWeekTstamp",e.$el.querySelectorAll(".booking-repeat-stop-week-tstamp")[0].value),t.append("moduleKey",e.options.moduleKey),Object.keys(e.bookingWindow.selectedTimeSlots).forEach(o=>{t.append("bookingDateSelection[]",e.bookingWindow.selectedTimeSlots[o])}),!0===e.options.callbacks.onBeforeBookingRequest.call(e,t)&&fetch(window.location.href,{method:"POST",body:t,headers:{"x-requested-with":"XMLHttpRequest"}}).then(o=>(e.checkResponse(o),o.json())).then(o=>{"success"===o.status?(e.bookingWindow.messages=o.data.messages,window.setTimeout(()=>{e.mode="main-window"},2500)):e.bookingWindow.messages=o.data.messages,e.bookingWindow.showConfirmationMsg=!0,e.fetchDataRequest()}).then(o=>{e.options.callbacks.onAfterBookingRequest.call(e,t)}).catch(o=>{e.isReady=!1,e.bookingWindow.showConfirmationMsg=!0,e.fetchDataRequest()})},bookingFormValidationRequest:function(){let e=this,o=new FormData;o.append("REQUEST_TOKEN",e.options.requestToken),o.append("action","bookingFormValidationRequest"),o.append("resourceId",e.bookingWindow.activeTimeSlot.resourceId),o.append("bookingRepeatStopWeekTstamp",e.$el.querySelectorAll(".booking-repeat-stop-week-tstamp")[0].value),o.append("moduleKey",e.options.moduleKey),Object.keys(e.bookingWindow.selectedTimeSlots).forEach(t=>{o.append("bookingDateSelection[]",e.bookingWindow.selectedTimeSlots[t])}),fetch(window.location.href,{method:"POST",body:o,headers:{"x-requested-with":"XMLHttpRequest"}}).then(o=>(e.checkResponse(o),o.json())).then(o=>{"success"===o.status&&(e.bookingFormValidation=o.data,e.isReady=!0)}).catch(o=>{e.isReady=!1})},cancelBookingRequest:function(){let e=this,o=new FormData;o.append("REQUEST_TOKEN",e.options.requestToken),o.append("action","cancelBookingRequest"),o.append("bookingId",e.bookingWindow.activeTimeSlot.bookingId),o.append("deleteBookingsWithSameBookingUuid",e.bookingWindow.deleteBookingsWithSameBookingUuid),o.append("moduleKey",e.options.moduleKey),fetch(window.location.href,{method:"POST",body:o,headers:{"x-requested-with":"XMLHttpRequest"}}).then(o=>(e.checkResponse(o),o.json())).then(o=>{"success"===o.status?(e.bookingWindow.messages=o.data.messages,window.setTimeout(()=>{e.mode="main-window"},2500)):e.bookingWindow.messages=o.data.messages,e.bookingWindow.deleteBookingsWithSameBookingUuid=!1,e.bookingWindow.showConfirmationMsg=!0,e.fetchDataRequest()}).catch(o=>{e.isReady=!1,e.bookingWindow.showConfirmationMsg=!0,e.fetchDataRequest(),e.bookingWindow.deleteBookingsWithSameBookingUuid=!1})},jumpWeekRequest:function(e,o){return o.preventDefault(),o.stopPropagation(),!this.isBusy&&(!(e===this.activeWeekTstamp||e<this.filterBoard.tstampFirstPossibleWeek||e>this.filterBoard.tstampLastPossibleWeek)&&void(this.activeWeekTstamp=e))},openBookingWindow:function(e,o){let t=this;t.mode="booking-window",t.bookingWindow.deleteBookingsWithSameBookingUuid=!1,t.bookingWindow.selectedTimeSlots=[],t.bookingWindow.action=o,t.bookingWindow.showConfirmationMsg=!1,t.bookingWindow.activeTimeSlot=e,t.bookingWindow.messages={confirmation:null,info:null,error:null},t.bookingWindow.selectedTimeSlots.push(e.bookingCheckboxValue),t.bookingFormValidation=[],"showBookingForm"===o&&window.setTimeout(()=>{t.bookingFormValidationRequest()},500),window.setTimeout(()=>{let e=t.$el.querySelector('.booking-window input[name="bookingDescription"]');null!==e&&e.setAttribute("value","");let o=t.$el.querySelectorAll(".booking-window .booking-repeat-stop-week-tstamp option");o.length>0&&o.forEach(e=>e.removeAttribute("selected"))},20)},hideBookingWindow:function(){this.mode="main-window"},toggleBackdrop:function(e=!0){if(e){let e=document.querySelectorAll(".resource-booking-backdrop-layer");e.length>0&&e.forEach(e=>e.parentNode.removeChild(e));let o=document.createElement("div");o.classList.add("resource-booking-backdrop-layer"),o.classList.add("show"),document.querySelector("body").append(o)}else window.setTimeout(()=>{let e=document.querySelectorAll(".resource-booking-backdrop-layer");e.length>0&&e.forEach(e=>e.parentNode.removeChild(e))},100)},checkResponse:function(e){this.lastResponseStatus=e.status,200!=e.status?this.isReady=!1:this.isReady=!0},initializeIdleDetectorOld:function(e){let o=this;$(document).idle({onIdle:()=>{o.isIdle=!0},onActive:()=>{o.isIdle=!1,o.fetchDataRequest()},idle:e})},initializeIdleDetector:function(e,o){let t=this,i=o;["keydown","mousemove","mousedown","touchstart"].forEach(n=>{e.addEventListener(n,()=>{t.isIdle&&(t.isIdle=!1,t.fetchDataRequest()),i=o},!1)}),window.setInterval(()=>{t.isIdle||(i-=1e3)<=0&&(t.isIdle=!0)},1e3)},playAudio:function(e){let o=new Audio(e);o.setAttribute("id","rbbBellRingtone"),null===document.querySelector("body audio")&&document.querySelector("body").appendChild(o),o.play()}}})}}